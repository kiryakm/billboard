<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Billboard</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <style>
       table {
           border-spacing: 7px 7px;
					 z-index: 0;

    border: 1px solid black; /* Рамка вокруг таблицы */
       }
       td {
  /*border-bottom:5pt solid black;*/
}
.can{z-index: 1;}
       .tab{
          /*  transform: scale(0.2,0.2);  /*уменьшаю canvas-ы что бы поместились на страницу, из-за этого они скачут*/
            position: relative;
            /*
            top: -400px;
            left: -400px;*/
       }

  </style>
</head>


    <table>
        <tr>
            <td>
                <p><input type = "radio" name = "choose" id = "hor" value = "hor" onchange = "makeTable()" >Horizontal</p>
            </td>
            <td>
                <p><input type = "radio" name = "choose" id = "vert" value = "vert" onchange = "makeTable()">Vertical</p>
            </td>
		        <td rowspan="2">
	              <canvas  id="origImg" name="origCanvas">
		        </td>
        </tr>
        <tr>
            <td>
                <button onclick="send()">Submit</button>
            </td>
            <td>
							<input type="file" name = "file" id = "pic" accept="image/*" onchange="makeTable()">
            </td>
        </tr>
				<tr>
					<td>
						Quantity of screens:
						<select name = "screens" id = "screens" onchange = "changeForm()">
						</select>
				</td>
				</tr>
    </table>
		<!--
    <table class = "tab" >
        <tr>
            <td>
                <canvas id="canvas1" name="canvas" height="240" width="320" style="border:1px solid #000000;"></canvas>
            </td>
            <td name = "canvas1920" >
            </td>

        </tr>
        <tr>
            <td name = "canvas1280">
            </td>
        </tr>
    </table>
		-->
    <table id = "drawTable">
    </table>

    <script>

				var origCanvas = document.getElementById('origImg');
				origCanvas.addEventListener('click', on_canvas_click, false);
				function on_canvas_click(ev) {
					/*var box = document.getElementById("drag-box");
					//box.style.height = "400px";
					box.style.width = "400px";*/
					var rect = origCanvas.getBoundingClientRect();
//alert(rect.top+" "+rect.right+" "+rect.bottom+" "+rect.left);
				    var x = ev.clientX - rect.left;
				    var y = ev.clientY - rect.top;
						alert(x+" "+y);


				    // ... x,y are the click coordinates relative to the
				    // canvas itself
				}

				function redraw(x, y)
				{
						var ctx = origCanvas.getContext("2d");

						pic = new Image();
						pic.src = URL.createObjectURL(document.getElementById('pic').files[0]); //беру загруженную картинку
						ctx.fillStyle = "#FFFFFF";
						ctx.fillRect(0,0, canvas.width, canvas.height);
						var rect = origCanvas.getBoundingClientRect();
					  var wx =pic.width/4- x/(pic.width/4));
						var hx =pic.height/4- y/(pic.height/4));
						pic.onload = function()   //отрисовываю поверх белого фона на canvas
						{


							ctx.drawImage(pic, 0, 0, pic.width/4, pic.height/4);
						}
				}

        function makeTable()
        {
            var height, width;
            if  (document.getElementById("hor").checked==true)
            {
                height = 960;
                width = 1280
            }
            if  (document.getElementById("vert").checked==true)
            {
                height = 1280;
                width = 960
            }
            pic = new Image();
            pic.src = URL.createObjectURL(document.getElementById('pic').files[0]); //беру загруженную картинку
            var inum = Math.ceil(pic.height/height);
            var jnum = Math.ceil(pic.width/width);
            var table = document.getElementById('drawTable');
						for (var i = 0; i < inum+jnum; i++)
            {
							var idRow= "tr"+i;
							if (document.getElementById(idRow))
								document.getElementById(idRow).remove();
						}

	          for (var i = 0; i < inum; i++)
            {
							var idRow= "tr"+i;
							var newRow = document.createElement('tr');
	            newRow.id = idRow;
            	table.appendChild(newRow);
              //newRow.insertCell(i);
							for (var j = 0; j < jnum; j++)
							{
								var idCol = "td"+i+"_"+j;
								var newCol = document.createElement('td');
								newCol.id = idCol;
								var str = '<canvas id="canvas'+ i + '_' + j + '" height="' + height/4 + '" width="'+ width/4 + '" style="border:1px solid #000000;"></canvas>'
								newCol.innerHTML += str;
								newRow.appendChild(newCol);

							}
            }
					draw2(inum, jnum);
        }

				function draw2(inum, jnum)
				{
            pic = new Image();
            pic.src = URL.createObjectURL(document.getElementById('pic').files[0]); //беру загруженную картинку
						pic.onload = function()   //отрисовываю поверх белого фона на canvas
						{

							var origCan = document.getElementById("origImg");
							var ctx = origCan.getContext("2d");
							origCan.height = pic.height/4;
							origCan.width = pic.width/4;
							ctx.drawImage(pic, 0, 0, pic.width/4, pic.height/4);

							var sumH = 0;
							for (var i = 0; i < inum; i++)
							{
							var sumW = 0;
								for (var j = 0; j < jnum; j++)
								{
									var canId = 'canvas'+ i + '_' + j;
									var canvas = document.getElementById(canId);
			            var ctx = canvas.getContext("2d");
			            ctx.fillStyle = "#FFFFFF";
			            ctx.fillRect(0,0, canvas.width, canvas.height);
			            ctx.drawImage(pic, -(sumW), -(sumH), pic.width/4, pic.height/4);

									sumW += canvas.width;
								}
							var canvas = document.getElementById("canvas0_0");
							sumH += canvas.height;

						}
					}
				}

				function makeSelect(inum, jnum)
				{
            var select = document.getElementById("screens");
						for (var i = inum; i > 0; i--)
						{

						}

				}

        var send = function()   //посылаю на сервер json с картинкой закодированной в base64
        {
						var inum = document.getElementById('drawTable').rows.length;
						var jnum = document.getElementById('drawTable').rows[0].cells.length;
						alert(inum+ ' '+ jnum);
            pic = new Image();
            pic.src = URL.createObjectURL(document.getElementById('pic').files[0]); //беру загруженную картинку
            pic.onload = function()   //отрисовываю поверх белого фона на canvas
            {
							var sumH = 0;
							for (var i = 0; i < inum; i++)
							{
							var sumW = 0;
							var url;
								for (var j = 0; j < jnum; j++)
								{
									var canId = 'canvas'+ i + '_' + j;
									var canvas = document.getElementById(canId);
									var ctx = canvas.getContext("2d");
	                canvas.height = canvas.height*4;
	                canvas.width = canvas.width*4;
									ctx.fillStyle = "#FFFFFF";
									ctx.fillRect(0,0, canvas.width, canvas.height);
									ctx.drawImage(pic, -(sumW), -(sumH), pic.width, pic.height);
	                url = document.getElementById(canId).toDataURL();   //беру url картинки из canvasar name;

	                if  (document.getElementById('vert').checked == true)
	                {
	                	name = "Vert"+pic.width+"x"+pic.height+" "+i+"_"+j;
	                }
									if  (document.getElementById('hor').checked == true)
	                {
	                	name = "Hor"+pic.width+"x"+pic.height+" "+i+"_"+j;
	                }

	                upload(url, name); // url - url картинки из canvas, name - название картинки, 1 - номер картинки


	                canvas.height = canvas.height/4;
	                canvas.width = canvas.width/4;
									ctx.fillStyle = "#FFFFFF";
									ctx.fillRect(0,0, canvas.width, canvas.height);
									ctx.drawImage(pic, -(sumW)/4, -(sumH)/4, pic.width/4, pic.height/4);
																		sumW += canvas.width*4;
								}
							var canvas = document.getElementById("canvas0_0");
							sumH += canvas.height*4;

						}
					}
								/*
                var canvas1 = document.getElementById("canvas1");
                var url;
                canvas1.height = canvas1.height*4;
                canvas1.width = canvas1.width*4;
                var ctx1 = canvas1.getContext("2d");
                ctx1.fillStyle = "#FFFFFF";
                ctx1.fillRect(0,0, canvas1.width, canvas1.height);
                ctx1.drawImage(pic, 0, 0, pic.width, pic.height);
                url = document.getElementById("canvas1").toDataURL();   //беру url картинки из canvas
                var name;
                for (var i = 0; i < document.getElementsByName('choose').length; i++) //получаю название картинки
                {
                    if  (document.getElementsByName('choose')[i].checked == true)
                    {
                        name = document.getElementsByName('choose')[i].value
                        break;
                    }
                }
                upload(url, name, 1); // url - url картинки из canvas, name - название картинки, 1 - номер картинки

                if (document.getElementById('canvas2') != null)   //если есть 2 канвас т.е. картинка больше 1280x960 посылаю вторую картинку
                {
                        var canvas2 = document.getElementById("canvas2");
                        canvas2.height = canvas1.height*4;
                        canvas2.width = canvas1.width*4;
                        var ctx2 = canvas2.getContext("2d");
                        ctx2.fillStyle = "#FFFFFF";
                        ctx2.fillRect(0,0, canvas2.width, canvas2.height);
                        if ((document.getElementById('canvas2') != null) && (document.getElementById("1280x1920").checked==true))
                            ctx2.drawImage(pic, 0, -(canvas2.height), pic.width, pic.height);
                        if ((document.getElementById('canvas2') != null) && (document.getElementById("1920x1280").checked==true))
                            ctx2.drawImage(pic, -(canvas2.width), 0, pic.width, pic.height);

                        url = document.getElementById("canvas2").toDataURL();
                        upload(url, name, 2);
                }
            }*/

        }

        function upload(dataURL, name) //функция с ajax запросом
        {
            // формирую json
            var data = {
                data: "'" + dataURL + "'",
                name: "" + name + ""
                };
            //отправляю json на сервер
            $.ajax({
                url: "/upload",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(data),
                type: 'POST'
                });
								/*
                if (num==1)
                {
                    var canvas1 = document.getElementById("canvas1");
                    canvas1.height = canvas1.height/4;
                    canvas1.width = canvas1.width/4;
                }
                if (num==2)   //если есть 2 канвас т.е. картинка больше 1280x960 посылаю вторую картинку
                {
                    var canvas2 = document.getElementById("canvas2");
                    canvas2.height = canvas2.height/4;
                    canvas2.width = canvas2.width/4;
                }
                draw();*/

            }

        function changeForm()
        {/*
            var form = document.getElementById("form");
            var quant = form.options[form.selectedIndex].id;
            var table = document.getElementById("drawTable");
            var canvas[quant][quant];
            for (var i = 0; i < quant; i++)
            {
              for (var j = 0; j < quant; j++)
              {
                  var row = table.insertRow(j);
                  canvas[i][j] = document.createElement("canvas");
                  canvas[i][j].id = "canvas2";
                  canvas[i][j].width = 240;
                  canvas[i][j].height = 320;
                  canvas[i][j].style.border = "1px solid";
              }
            }
            */
        }
        // функции для изменения размеров canvas-ов и добавления 2-го если нужно
        var change1280x960 = function()
        {
            var canvas1 = document.getElementById("canvas1");
            var ctx = canvas1.getContext("2d");
            canvas1.width = 320;
            canvas1.height = 240;
            if (document.getElementById('canvas2') != null)
                document.getElementById('canvas2').remove();
            draw();
        }

        var change960x1280 = function()
        {
            var canvas1 = document.getElementById("canvas1");
            canvas1.width = 240;
            canvas1.height = 320;
            if (document.getElementById('canvas2') != null)
                document.getElementById('canvas2').remove();
            draw();
        }

        var change1280x1920 = function()
        {
            var canvas1 = document.getElementById("canvas1");
            canvas1.width = 320;
            canvas1.height = 240;
            if (document.getElementById('canvas2') != null)
                document.getElementById('canvas2').remove();
            var canvas2 = document.createElement("canvas");
            canvas2.id = "canvas2";
            canvas2.width = 320;
            canvas2.height = 240;
            canvas2.style.border = "1px solid";
            var body = document.getElementsByName("canvas1280")[0];
            body.appendChild(canvas2);
            draw();
        }

        var change1920x1280 = function()
        {
            var canvas1 = document.getElementById("canvas1");
            canvas1.width = 240;
            canvas1.height = 320;
            if (document.getElementById('canvas2') != null)
                document.getElementById('canvas2').remove();
            var canvas2 = document.createElement("canvas");
            canvas2.id = "canvas2";
            canvas2.width = 240;
            canvas2.height = 320;
            canvas2.style.border = "1px solid";
            var body = document.getElementsByName("canvas1920")[0];
            body.appendChild(canvas2);
            draw();
        }

        //отрисовка картинки
        var draw = function()
        {
            pic = new Image();
            pic.src = URL.createObjectURL(document.getElementById('pic').files[0]); //беру загруженную картинку
            var origCan = document.getElementById("origImg");
            var ctx = origCan.getContext("2d");
            origImg.src = URL.createObjectURL(document.getElementById('pic').files[0]);
            var canvas1 = document.getElementById("canvas1");
            var ctx1 = canvas1.getContext("2d");
            ctx1.fillStyle = "#FFFFFF";
            ctx1.fillRect(0,0, canvas1.width, canvas1.height);
            if (document.getElementById('canvas2') != null)
            {
                var canvas2 = document.getElementById("canvas2");
                var ctx2 = canvas2.getContext("2d");
                ctx2.fillStyle = "#FFFFFF";
                ctx2.fillRect(0,0, canvas2.width, canvas2.height);
            }
            pic.onload = function()   //отрисовываю поверх белого фона на canvas
            {
                //отрисовка орингинала
                origCan.height = pic.height/4;
                origCan.width = pic.width/4;
                ctx.drawImage(pic, 0, 0, pic.width/4, pic.height/4);
                //отрисовка порезанных
                ctx1.drawImage(pic, 0, 0, pic.width/4, pic.height/4);
                if ((document.getElementById('canvas2') != null) && (document.getElementById("1280x1920").checked==true))
                    ctx2.drawImage(pic, 0, -(canvas1.height), pic.width/4, pic.height/4);
                if ((document.getElementById('canvas2') != null) && (document.getElementById("1920x1280").checked==true))
                    ctx2.drawImage(pic, -(canvas1.width), 0, pic.width/4, pic.height/4);
            }
        }
    </script>
</body>
</html>
